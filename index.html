<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif; background:#0b0e11; color:#e4e6eb; display:flex; height:100vh; overflow:hidden; }
  
  /* Sidebar */
  #sidebar { width:320px; background:#1c1e22; display:none; flex-direction:column; border-right:1px solid #2d3035; }
  #sidebar.active { display:flex; }
  #sidebar-header { padding:20px; background:#16181c; border-bottom:1px solid #2d3035; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; box-shadow:0 1px 3px rgba(0,0,0,0.3); }
  #sidebar-header h2 { font-size:18px; font-weight:700; color:#fff; letter-spacing:-0.3px; }
  #sidebar-content { flex:1; overflow-y:auto; padding:12px; }
  #sidebar-content::-webkit-scrollbar { width:8px; }
  #sidebar-content::-webkit-scrollbar-track { background:transparent; }
  #sidebar-content::-webkit-scrollbar-thumb { background:#2d3035; border-radius:4px; }
  #sidebar-content::-webkit-scrollbar-thumb:hover { background:#3a3d43; }
  
  .section-title { font-size:11px; font-weight:700; text-transform:uppercase; color:#8b8d94; padding:20px 12px 8px; display:flex; justify-content:space-between; align-items:center; letter-spacing:0.5px; }
  .add-btn { background:none; border:none; color:#8b8d94; cursor:pointer; font-size:20px; padding:0; width:24px; height:24px; border-radius:4px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .add-btn:hover { background:#3ba55d; color:#fff; transform:scale(1.1); }
  
  .friend-div, .group-div { display:flex; align-items:center; padding:10px 12px; margin:3px 0; border-radius:8px; cursor:pointer; transition:all 0.15s; background:transparent; }
  .friend-div:hover, .group-div:hover { background:#2d3035; }
  .friend-div.active, .group-div.active { background:#3a3d43; }
  .friend-div img, .group-div .group-icon { width:40px; height:40px; border-radius:50%; margin-right:14px; object-fit:cover; flex-shrink:0; }
  .group-icon { background:linear-gradient(135deg, #5865f2 0%, #7289da 100%); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.2); }
  .friend-info, .group-info { flex:1; min-width:0; }
  .friend-name, .group-name { font-size:16px; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
  .friend-status { font-size:13px; color:#8b8d94; margin-top:2px; display:flex; align-items:center; }
  .status-indicator { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; border:2px solid #1c1e22; }
  .status-online { background:#3ba55d; box-shadow:0 0 6px rgba(59,165,93,0.6); } 
  .status-offline { background:#5e6066; }
  
  .request-div { background:#2d3035; border:1px solid #3a3d43; padding:14px; margin:6px 0; border-radius:10px; cursor:default; }
  .request-text { font-size:15px; margin-bottom:12px; color:#e4e6eb; }
  .request-text strong { color:#fff; font-weight:600; }
  .request-buttons { display:flex; gap:10px; }
  
  .input-form { display:none; padding:14px; background:#2d3035; border-radius:10px; margin:8px 0; border:1px solid #3a3d43; }
  .input-form.active { display:block; animation:slideDown 0.2s ease; }
  @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
  
  #user-controls { padding:16px; background:#16181c; border-top:1px solid #2d3035; display:flex; gap:10px; margin-top:auto; flex-shrink:0; box-shadow:0 -1px 3px rgba(0,0,0,0.2); }
  
  /* Buttons */
  .btn { padding:10px 18px; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .btn-primary { background:#5865f2; color:#fff; box-shadow:0 2px 6px rgba(88,101,242,0.3); }
  .btn-primary:hover { background:#4752c4; box-shadow:0 4px 12px rgba(88,101,242,0.4); transform:translateY(-1px); }
  .btn-secondary { background:#3a3d43; color:#fff; }
  .btn-secondary:hover { background:#4a4d54; }
  .btn-danger { background:#ed4245; color:#fff; box-shadow:0 2px 6px rgba(237,66,69,0.3); }
  .btn-danger:hover { background:#c03537; box-shadow:0 4px 12px rgba(237,66,69,0.4); transform:translateY(-1px); }
  .btn-success { background:#3ba55d; color:#fff; width:100%; box-shadow:0 2px 6px rgba(59,165,93,0.3); }
  .btn-success:hover { background:#2d7d46; box-shadow:0 4px 12px rgba(59,165,93,0.4); transform:translateY(-1px); }
  .btn-small { padding:8px 14px; font-size:13px; }
  
  /* Auth Screen */
  #auth { display:flex; align-items:center; justify-content:center; height:100%; width:100%; background:linear-gradient(135deg,#5865f2 0%,#7289da 50%,#3ba55d 100%); }
  #auth-box { background:#1c1e22; padding:40px; border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,0.5); width:100%; max-width:440px; }
  #auth-title { font-size:28px; font-weight:800; color:#fff; margin-bottom:10px; text-align:center; }
  #auth-subtitle { font-size:15px; color:#8b8d94; margin-bottom:32px; text-align:center; }
  #auth-msg { background:#ed4245; color:#fff; padding:14px; border-radius:8px; font-size:14px; margin-bottom:20px; display:none; font-weight:500; }
  #auth-msg.show { display:block; animation:shake 0.3s; }
  @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-10px); } 75% { transform:translateX(10px); } }
  .auth-input-group { margin-bottom:18px; }
  .auth-input-label { display:block; font-size:12px; font-weight:700; color:#8b8d94; text-transform:uppercase; margin-bottom:10px; letter-spacing:0.5px; }
  .auth-buttons { display:flex; gap:14px; margin-top:28px; }
  .auth-buttons .btn { flex:1; padding:14px; font-size:15px; }
  input[type="text"], input[type="password"] { width:100%; padding:12px 14px; background:#2d3035; border:1px solid #3a3d43; border-radius:8px; color:#e4e6eb; font-size:15px; margin:8px 0; transition:all 0.2s; direction:ltr; text-align:left; }
  input[type="text"]:focus, input[type="password"]:focus { outline:none; border-color:#5865f2; background:#36393f; box-shadow:0 0 0 3px rgba(88,101,242,0.1); }
  input::placeholder { color:#5e6066; }
  
  /* Main Chat Area */
  #main { flex:1; display:flex; flex-direction:column; background:#0b0e11; position:relative; }
  #chat-header { height:64px; background:#1c1e22; border-bottom:1px solid #2d3035; display:none; align-items:center; padding:0 20px; box-shadow:0 1px 3px rgba(0,0,0,0.3); flex-shrink:0; }
  #chat-header.active { display:flex; }
  #chat-header-info { display:flex; align-items:center; flex:1; }
  #chat-header-img { width:36px; height:36px; border-radius:50%; margin-right:14px; object-fit:cover; border:2px solid #2d3035; }
  #chat-header-name { font-size:17px; font-weight:700; color:#fff; letter-spacing:-0.3px; }
  
  #chat { flex:1; overflow-y:auto; padding:20px; display:none; background:#0b0e11; }
  #chat.active { display:block; }
  #chat::-webkit-scrollbar { width:12px; }
  #chat::-webkit-scrollbar-track { background:transparent; }
  #chat::-webkit-scrollbar-thumb { background:#2d3035; border-radius:6px; border:3px solid #0b0e11; }
  #chat::-webkit-scrollbar-thumb:hover { background:#3a3d43; }
  
  .message-div { display:flex; align-items:flex-start; padding:6px 12px; margin:2px 0; transition:background 0.1s; border-radius:6px; }
  .message-div:hover { background:rgba(45,48,53,0.3); }
  .message-div img { width:44px; height:44px; border-radius:50%; margin-right:14px; object-fit:cover; flex-shrink:0; border:2px solid #1c1e22; }
  .message-content { flex:1; min-width:0; }
  .message-header { display:flex; align-items:center; margin-bottom:4px; gap:10px; }
  .message-sender { font-size:16px; font-weight:600; color:#fff; }
  .message-time { font-size:12px; color:#5e6066; font-weight:500; }
  .message-text { font-size:15px; color:#e4e6eb; line-height:1.6; word-wrap:break-word; direction:ltr; unicode-bidi:embed; text-align:left; margin-left:0; }
  
  #send-div { padding:20px; display:none; background:#0b0e11; border-top:1px solid #2d3035; }
  #send-div.active { display:block; }
  .send-container { background:#2d3035; border-radius:10px; padding:6px; display:flex; align-items:center; gap:10px; border:1px solid #3a3d43; transition:border 0.2s; }
  .send-container:focus-within { border-color:#5865f2; box-shadow:0 0 0 3px rgba(88,101,242,0.1); }
  #message { flex:1; background:transparent; border:none; padding:10px 14px; color:#e4e6eb; font-size:15px; margin:0; direction:ltr; text-align:left; }
  #message:focus { outline:none; }
  #message::placeholder { color:#5e6066; }
  .send-btn { background:#5865f2; border:none; color:#fff; padding:12px 20px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; box-shadow:0 2px 6px rgba(88,101,242,0.3); }
  .send-btn:hover { background:#4752c4; box-shadow:0 4px 12px rgba(88,101,242,0.4); transform:translateY(-1px); }
  
  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#5e6066; }
  .empty-icon { font-size:72px; margin-bottom:20px; opacity:0.3; }
  .empty-text { font-size:17px; font-weight:600; }
  
  /* Context Menu */
  .context-menu { position:fixed; background:#16181c; border:1px solid #2d3035; border-radius:10px; padding:6px 0; box-shadow:0 8px 24px rgba(0,0,0,0.5); z-index:10000; display:none; min-width:160px; }
  .context-menu-item { padding:10px 16px; cursor:pointer; font-size:14px; color:#e4e6eb; transition:background 0.1s; white-space:nowrap; font-weight:500; }
  .context-menu-item:hover { background:#3a3d43; }
  .context-menu-item.danger { color:#ed4245; }
  .context-menu-item.danger:hover { background:#ed4245; color:#fff; }
  
  /* Confirmation Modal */
  .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:20000; backdrop-filter:blur(4px); }
  .modal-overlay.active { display:flex; animation:fadeIn 0.2s; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  .modal-box { background:#1c1e22; border-radius:12px; padding:28px; max-width:460px; width:90%; box-shadow:0 12px 48px rgba(0,0,0,0.6); animation:slideUp 0.3s; }
  @keyframes slideUp { from { transform:translateY(30px); opacity:0; } to { transform:translateY(0); opacity:1; } }
  .modal-title { font-size:22px; font-weight:700; color:#fff; margin-bottom:14px; }
  .modal-message { font-size:15px; color:#8b8d94; margin-bottom:28px; line-height:1.5; }
  .modal-buttons { display:flex; gap:12px; justify-content:flex-end; }
  .modal-buttons .btn { min-width:90px; }
  
  /* Members Panel */
  #member-panel { position:fixed; top:0; right:-340px; width:340px; height:100vh; background:#1c1e22; border-left:1px solid #2d3035; padding:20px; transition:right 0.3s cubic-bezier(0.4,0,0.2,1); overflow-y:auto; z-index:1000; box-shadow:-4px 0 16px rgba(0,0,0,0.4); }
  #member-panel.active { right:0; }
  #member-panel::-webkit-scrollbar { width:8px; }
  #member-panel::-webkit-scrollbar-track { background:transparent; }
  #member-panel::-webkit-scrollbar-thumb { background:#2d3035; border-radius:4px; }
  #member-panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  #member-panel-header h3 { font-size:18px; font-weight:700; color:#fff; }
  .member-div { display:flex; align-items:center; padding:10px 12px; margin:4px 0; border-radius:8px; background:#2d3035; }
  .member-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#5865f2 0%,#7289da 100%); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; margin-right:12px; font-size:16px; }
  .member-info { flex:1; }
  .member-name { font-size:15px; color:#fff; font-weight:600; }
  .member-status { font-size:13px; margin-top:2px; color:#8b8d94; display:flex; align-items:center; }
  
  /* Invite Section */
  #invite-section { display:none; padding:16px; background:#2d3035; border-radius:10px; margin:12px 0; border:1px solid #3a3d43; }
  #invite-section.active { display:block; }
  .invite-title { font-size:14px; font-weight:700; color:#fff; margin-bottom:14px; text-transform:uppercase; letter-spacing:0.5px; }
  .invite-form { display:flex; gap:10px; flex-direction:column; }
  .invite-form input { flex:1; margin:0; padding:12px 14px; font-size:15px; min-width:0; }
  .invite-form .btn { width:100%; }
  
  @media(max-width:768px) { 
    #sidebar { width:100%; position:absolute; z-index:100; } 
    #member-panel { width:100%; right:-100%; }
  }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <h2>ðŸ’¬ Chats</h2>
  </div>
  <div id="sidebar-content">
    <div class="section-title">Friends <button class="add-btn" id="add-friend-btn">+</button></div>
    <div class="input-form" id="add-friend-form">
      <input type="text" id="friend-username" placeholder="Enter username">
      <button class="btn btn-primary btn-small" id="send-request-btn">Send Request</button>
    </div>
    <div id="friend-list"></div>
    <div class="section-title" style="margin-top:16px;">Friend Requests</div>
    <div id="request-list"></div>
    <div class="section-title" style="margin-top:16px;">Groups <button class="add-btn" id="create-group-btn">+</button></div>
    <div class="input-form" id="create-group-form">
      <input type="text" id="group-name" placeholder="Group name">
      <button class="btn btn-primary btn-small" id="create-group-confirm">Create</button>
    </div>
    <div id="group-list"></div>
    
    <div id="invite-section">
      <div class="invite-title">Invite to Group</div>
      <div class="invite-form">
        <input type="text" id="invite-username" placeholder="Friend username">
        <button class="btn btn-success btn-small" id="invite-btn">Invite</button>
      </div>
    </div>
  </div>
  <div id="user-controls">
    <button class="btn btn-secondary btn-small" id="change-pfp-btn">Change Avatar</button>
    <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
  </div>
  <div class="input-form" id="change-pfp-form" style="margin:0 12px 12px;">
    <input type="text" id="new-pfp-url" placeholder="Profile picture URL">
    <button class="btn btn-primary btn-small" id="save-pfp-btn">Save</button>
  </div>
</div>

<div id="main">
  <div id="auth">
    <div id="auth-box">
      <h2 id="auth-title">Welcome Back!</h2>
      <p id="auth-subtitle">We're so excited to see you again!</p>
      <div id="auth-msg"></div>
      <div class="auth-input-group">
        <label class="auth-input-label">Username</label>
        <input type="text" id="username" placeholder="Enter your username">
      </div>
      <div class="auth-input-group">
        <label class="auth-input-label">Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <div class="auth-input-group" id="profile-pic-group" style="display:none;">
        <label class="auth-input-label">Profile Picture URL (Optional)</label>
        <input type="text" id="profile-pic" placeholder="https://example.com/avatar.jpg">
      </div>
      <div class="auth-buttons">
        <button class="btn btn-primary" id="auth-btn">Sign In</button>
        <button class="btn btn-secondary" id="toggle-btn">Sign Up</button>
      </div>
      <button class="btn btn-success" id="google-btn" style="margin-top:12px;">Sign in with Google</button>
    </div>
  </div>

  <div id="chat-header">
    <div id="chat-header-info">
      <img id="chat-header-img" src="" alt="">
      <span id="chat-header-name"></span>
    </div>
    <button class="btn btn-primary btn-small" id="member-toggle">Members</button>
  </div>

  <div id="chat">
    <div class="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div class="empty-text">Select a chat to start messaging</div>
    </div>
  </div>

  <div id="send-div">
    <div class="send-container">
      <input type="text" id="message" placeholder="Type a message...">
      <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<div id="member-panel">
  <div id="member-panel-header">
    <h3>Members</h3>
    <button class="btn btn-danger btn-small" id="member-close">Close</button>
  </div>
</div>

<div id="context-menu" class="context-menu">
  <div class="context-menu-item" id="context-edit">Edit Message</div>
  <div class="context-menu-item danger" id="context-delete">Delete Message</div>
</div>

<div id="confirm-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Confirm Action</div>
    <div class="modal-message" id="modal-message">Are you sure?</div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
      <button class="btn btn-danger" id="modal-confirm">Delete</button>
    </div>
  </div>
</div>

<div id="edit-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">Edit Message</div>
    <div class="modal-message">
      <input type="text" id="edit-input" placeholder="Enter new message" style="width:100%; padding:12px; background:#40444b; border:1px solid #5865f2; border-radius:6px; color:#dcddde; font-size:15px; margin-top:8px; direction:ltr; text-align:left;">
    </div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="edit-cancel">Cancel</button>
      <button class="btn btn-primary" id="edit-save">Save</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDJBkKZt3tRjrOxBXOhWmgu-faYMFvDaKw",
  authDomain: "chat-c5c92.firebaseapp.com",
  databaseURL: "https://chat-c5c92-default-rtdb.firebaseio.com",
  projectId: "chat-c5c92",
  storageBucket: "chat-c5c92.firebasestorage.app",
  messagingSenderId: "860358701745",
  appId: "1:860358701745:web:7ecfc8dd659396a0af6890",
  measurementId: "G-MYPKD9R9JD"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const usersRef = db.ref("users");
const messagesRef = db.ref("messages/dm");
const groupsRef = db.ref("groups");

let currentUser = null;
let currentUserUid = null;
let currentChat = null;
let isSignUp = false;

const authDiv = document.getElementById("auth");
const authBtn = document.getElementById("auth-btn");
const toggleBtn = document.getElementById("toggle-btn");
const authMsg = document.getElementById("auth-msg");
const profilePicGroup = document.getElementById("profile-pic-group");
const sidebar = document.getElementById("sidebar");
const googleBtn = document.getElementById("google-btn");
const chatDiv = document.getElementById("chat");
const chatHeader = document.getElementById("chat-header");
const sendDiv = document.getElementById("send-div");

toggleBtn.onclick = () => {
  isSignUp = !isSignUp;
  if (isSignUp) {
    profilePicGroup.style.display = "block";
    authBtn.textContent = "Sign Up";
    toggleBtn.textContent = "Sign In";
  } else {
    profilePicGroup.style.display = "none";
    authBtn.textContent = "Sign In";
    toggleBtn.textContent = "Sign Up";
  }
  authMsg.classList.remove("show");
};

function showAuthMsg(msg) {
  authMsg.textContent = msg;
  authMsg.classList.add("show");
}

authBtn.onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const profilePic = document.getElementById("profile-pic").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg";

  if (!username || !password) { showAuthMsg("Enter username and password"); return; }

  // FIXED: Changed from @dummy.com to @chatapp.com
  if (isSignUp) {
    auth.createUserWithEmailAndPassword(username+"@chatapp.com", password)
      .then(cred => {
        const uid = cred.user.uid;
        usersRef.child(uid).set({ username, profilePic, friends:{}, requests:{}, online:true });
        login(uid, username);
      })
      .catch(err => showAuthMsg(err.message));
  } else {
    auth.signInWithEmailAndPassword(username+"@chatapp.com", password)
      .then(cred => {
        const uid = cred.user.uid;
        usersRef.child(uid).update({ online:true });
        usersRef.child(uid).once('value').then(snap => {
          login(uid, snap.val().username);
        });
      })
      .catch(err => showAuthMsg(err.message));
  }
};

googleBtn.onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    const user = result.user;
    
    // Extract username from email (remove @gmail.com or any domain)
    const emailUsername = user.email.split('@')[0];
    
    usersRef.child(user.uid).once("value").then(snap => {
      if (!snap.exists()) {
        usersRef.child(user.uid).set({ 
          username: emailUsername, 
          profilePic: user.photoURL, 
          friends:{}, 
          requests:{}, 
          online:true 
        });
        login(user.uid, emailUsername);
      } else {
        usersRef.child(user.uid).update({ online:true });
        login(user.uid, snap.val().username);
      }
    });
  }).catch(err => showAuthMsg(err.message));
};

function login(uid, username) {
  currentUser = username;
  currentUserUid = uid;
  localStorage.setItem("miniDiscordUser", uid);
  authDiv.style.display = "none";
  sidebar.classList.add("active");
  
  // Hide invite section by default
  document.getElementById("invite-section").classList.remove("active");
  
  loadFriends();
  loadRequests();
  loadGroups();
}

function logout() {
  if (currentUserUid) {
    usersRef.child(currentUserUid).update({ online:false });
  }
  auth.signOut();
  localStorage.removeItem("miniDiscordUser");
  currentUser = null;
  currentUserUid = null;
  currentChat = null;
  sidebar.classList.remove("active");
  chatDiv.classList.remove("active");
  chatHeader.classList.remove("active");
  sendDiv.classList.remove("active");
  authDiv.style.display = "flex";
}

function loadFriends() {
  const friendListDiv = document.getElementById("friend-list");
  friendListDiv.innerHTML = "";
  usersRef.child(currentUserUid).child("friends").on("value", snapshot => {
    friendListDiv.innerHTML = "";
    snapshot.forEach(f => {
      const friendUid = f.key;
      usersRef.child(friendUid).once("value").then(friendSnap => {
        const friendData = friendSnap.val();
        const div = document.createElement("div");
        div.className = "friend-div";
        div.innerHTML = `
          <img src="${friendData.profilePic || 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg'}">
          <div class="friend-info">
            <div class="friend-name">${friendData.username}</div>
            <div class="friend-status">
              <span class="status-indicator ${friendData.online ? 'status-online' : 'status-offline'}"></span>
              ${friendData.online ? 'Online' : 'Offline'}
            </div>
          </div>
        `;
        div.onclick = () => openDM(friendUid, friendData);
        friendListDiv.appendChild(div);
      });
    });
  });
}

function loadRequests() {
  const requestListDiv = document.getElementById("request-list");
  requestListDiv.innerHTML = "";
  usersRef.child(currentUserUid).child("requests").on("value", snapshot => {
    requestListDiv.innerHTML = "";
    snapshot.forEach(r => {
      const requesterUid = r.key;
      usersRef.child(requesterUid).once("value").then(reqSnap => {
        const requester = reqSnap.val();
        const div = document.createElement("div");
        div.className = "request-div";
        div.innerHTML = `
          <div class="request-text"><strong>${requester.username}</strong> wants to be friends</div>
          <div class="request-buttons">
            <button class="btn btn-success btn-small">Accept</button>
            <button class="btn btn-danger btn-small">Decline</button>
          </div>
        `;
        div.querySelector(".btn-success").onclick = () => {
          usersRef.child(currentUserUid).child("friends").child(requesterUid).set(true);
          usersRef.child(requesterUid).child("friends").child(currentUserUid).set(true);
          usersRef.child(currentUserUid).child("requests").child(requesterUid).remove();
        };
        div.querySelector(".btn-danger").onclick = () => {
          usersRef.child(currentUserUid).child("requests").child(requesterUid).remove();
        };
        requestListDiv.appendChild(div);
      });
    });
  });
}

function loadGroups() {
  const groupListDiv = document.getElementById("group-list");
  groupListDiv.innerHTML = "";
  groupsRef.on("value", snapshot => {
    groupListDiv.innerHTML = "";
    snapshot.forEach(g => {
      const data = g.val();
      const name = g.key;
      if (!data.members || !data.members[currentUserUid]) return;
      const div = document.createElement("div");
      div.className = "group-div";
      const iconLetter = name.charAt(0).toUpperCase();
      div.innerHTML = `
        <div class="group-icon">${iconLetter}</div>
        <div class="group-info"><div class="group-name">${name}</div></div>
      `;
      div.onclick = () => joinGroup(name);
      groupListDiv.appendChild(div);
    });
  });
}

function openDM(friendUid, friendData) {
  currentChat = { type: "dm", uid: friendUid };
  chatDiv.innerHTML = "";
  chatDiv.classList.add("active");
  chatHeader.classList.add("active");
  sendDiv.classList.add("active");
  
  // Hide invite section in DMs
  document.getElementById("invite-section").classList.remove("active");
  
  document.getElementById("chat-header-img").src = friendData.profilePic;
  document.getElementById("chat-header-img").style.display = "block";
  document.getElementById("chat-header-name").textContent = friendData.username;
  
  const key = [currentUserUid, friendUid].sort().join("_");
  const ref = messagesRef.child(key);
  
  // Turn off all existing listeners
  ref.off();
  
  // Load ALL messages, sort manually, then display
  ref.once("value").then(snapshot => {
    chatDiv.innerHTML = "";
    
    // Get all messages into an array
    const messages = [];
    snapshot.forEach(childSnap => {
      const data = childSnap.val();
      messages.push({
        id: childSnap.key,
        data: data,
        timestamp: data.timestamp || 0
      });
    });
    
    // Sort by timestamp (oldest first)
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    // Render all messages in order
    messages.forEach(msg => {
      renderMessageDirect(msg.id, msg.data, ref);
    });
    
    // Listen for NEW messages only
    const lastTimestamp = messages.length > 0 ? messages[messages.length - 1].timestamp : 0;
    ref.orderByChild("timestamp").startAt(lastTimestamp + 1).on("child_added", snap => {
      renderMessageDirect(snap.key, snap.val(), ref);
    });
  });
  
  ref.on("child_changed", snap => {
    const m = document.getElementById("msg-" + snap.key);
    if (m) {
      const text = m.querySelector(".message-text");
      if (text) text.textContent = snap.val().text;
    }
  });
  ref.on("child_removed", snap => {
    const m = document.getElementById("msg-" + snap.key);
    if (m) m.remove();
  });
}

function renderMessageDirect(id, data, ref) {
  if (document.getElementById("msg-" + id)) return;

  const div = document.createElement("div");
  div.className = "message-div";
  div.id = "msg-" + id;
  div.dataset.timestamp = data.timestamp || 0;

  usersRef.child(data.senderUid).once("value").then(senderSnap => {
    const sender = senderSnap.val();

    const content = document.createElement("div");
    content.className = "message-content";

    const header = document.createElement("div");
    header.className = "message-header";

    const senderSpan = document.createElement("span");
    senderSpan.className = "message-sender";
    senderSpan.textContent = sender.username;

    const time = document.createElement("span");
    time.className = "message-time";
    time.textContent = new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

    header.appendChild(senderSpan);
    header.appendChild(time);

    const text = document.createElement("div");
    text.className = "message-text";
    text.textContent = data.text;

    content.appendChild(header);
    content.appendChild(text);

    const img = document.createElement("img");
    img.src = sender.profilePic || 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg';

    div.appendChild(img);
    div.appendChild(content);

    // Add context menu for own messages
    if (data.senderUid === currentUserUid) {
      let pressTimer;
      
      div.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => {
          showContextMenu(e.touches[0].clientX, e.touches[0].clientY, id, data.text, ref);
          e.preventDefault();
        }, 500);
      });
      
      div.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
      });
      
      div.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
      });
      
      div.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, id, data.text, ref);
      });
    }

    // ðŸ”¥ INSERT IN CORRECT ORDER (THIS IS THE FIX)
    const existingMessages = Array.from(chatDiv.children);
    let inserted = false;

    for (let msg of existingMessages) {
      const msgTime = parseInt(msg.dataset.timestamp || 0);
      if (data.timestamp < msgTime) {
        chatDiv.insertBefore(div, msg);
        inserted = true;
        break;
      }
    }

    if (!inserted) {
      chatDiv.appendChild(div);
    }

    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}

function joinGroup(name) {
  currentChat = { type: "group", name };
  chatDiv.innerHTML = "";
  chatDiv.classList.add("active");
  chatHeader.classList.add("active");
  sendDiv.classList.add("active");
  document.getElementById("chat-header-img").style.display = "none";
  document.getElementById("chat-header-name").textContent = "# " + name;
  
  const ref = groupsRef.child(name).child("messages");
  
  // Turn off all existing listeners
  ref.off();
  
  // Load ALL messages, sort manually, then display
  ref.once("value").then(snapshot => {
    chatDiv.innerHTML = "";
    
    // Get all messages into an array
    const messages = [];
    snapshot.forEach(childSnap => {
      const data = childSnap.val();
      messages.push({
        id: childSnap.key,
        data: data,
        timestamp: data.timestamp || 0
      });
    });
    
    // Sort by timestamp (oldest first)
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    // Render all messages in order
    messages.forEach(msg => {
      renderMessageDirect(msg.id, msg.data, ref);
    });
    
    // Listen for NEW messages only
    const lastTimestamp = messages.length > 0 ? messages[messages.length - 1].timestamp : 0;
    ref.orderByChild("timestamp").startAt(lastTimestamp + 1).on("child_added", snap => {
      renderMessageDirect(snap.key, snap.val(), ref);
    });
  });
  
  ref.on("child_changed", snap => {
    const m = document.getElementById("msg-" + snap.key);
    if (m) {
      const text = m.querySelector(".message-text");
      if (text) text.textContent = snap.val().text;
    }
  });
  ref.on("child_removed", snap => {
    const m = document.getElementById("msg-" + snap.key);
    if (m) m.remove();
  });
  
  // Show invite section if user is group creator
  groupsRef.child(name).get().then(snap => {
    const inviteSection = document.getElementById("invite-section");
    if (snap.val().creator === currentUserUid) {
      inviteSection.classList.add("active");
    } else {
      inviteSection.classList.remove("active");
    }
    updateMembers();
  });
}

// Custom confirmation modal
let confirmCallback = null;

function showConfirmModal(title, message, onConfirm, confirmText = "Confirm") {
  const modal = document.getElementById('confirm-modal');
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-message').textContent = message;
  document.getElementById('modal-confirm').textContent = confirmText;
  modal.classList.add('active');
  confirmCallback = onConfirm;
}

function hideConfirmModal() {
  document.getElementById('confirm-modal').classList.remove('active');
  confirmCallback = null;
}

document.getElementById('modal-cancel').addEventListener('click', hideConfirmModal);
document.getElementById('modal-confirm').addEventListener('click', () => {
  if (confirmCallback) confirmCallback();
  hideConfirmModal();
});

// Custom edit modal
let editCallback = null;

function showEditModal(currentText, onSave) {
  const modal = document.getElementById('edit-modal');
  const input = document.getElementById('edit-input');
  input.value = currentText;
  modal.classList.add('active');
  editCallback = onSave;
  
  // Focus input after modal is shown
  setTimeout(() => {
    input.focus();
    input.select();
  }, 100);
}

function hideEditModal() {
  document.getElementById('edit-modal').classList.remove('active');
  document.getElementById('edit-input').value = '';
  editCallback = null;
}

document.getElementById('edit-cancel').addEventListener('click', hideEditModal);
document.getElementById('edit-save').addEventListener('click', () => {
  const newText = document.getElementById('edit-input').value.trim();
  if (newText && editCallback) {
    editCallback(newText);
  }
  hideEditModal();
});

// Allow Enter key to save in edit modal
document.getElementById('edit-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('edit-save').click();
  }
});

// Context menu functions
let currentMessageId = null;
let currentMessageText = null;
let currentMessageRef = null;

function showContextMenu(x, y, messageId, messageText, ref) {
  const menu = document.getElementById('context-menu');
  currentMessageId = messageId;
  currentMessageText = messageText;
  currentMessageRef = ref;
  
  menu.style.display = 'block';
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  
  // Adjust if menu goes off screen
  setTimeout(() => {
    const rect = menu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
      menu.style.left = (x - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
      menu.style.top = (y - rect.height) + 'px';
    }
  }, 0);
}

function hideContextMenu() {
  document.getElementById('context-menu').style.display = 'none';
  currentMessageId = null;
  currentMessageText = null;
  currentMessageRef = null;
}

// Close context menu when clicking outside (but not on menu items)
document.addEventListener('click', (e) => {
  if (!e.target.closest('.context-menu-item') && !e.target.closest('.context-menu')) {
    hideContextMenu();
  }
});

// Edit message
document.getElementById('context-edit').addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  if (currentMessageId && currentMessageRef && currentMessageText) {
    const msgId = currentMessageId;
    const msgRef = currentMessageRef;
    const msgText = currentMessageText;
    
    hideContextMenu();
    
    showEditModal(msgText, (newText) => {
      console.log("Editing message:", msgId, "New text:", newText);
      msgRef.child(msgId).update({ text: newText });
    });
  }
});

// Delete message
document.getElementById('context-delete').addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  if (currentMessageId && currentMessageRef) {
    const msgId = currentMessageId;
    const msgRef = currentMessageRef;
    
    hideContextMenu();
    
    showConfirmModal(
      "Delete Message",
      "Are you sure you want to delete this message? This cannot be undone.",
      () => {
        console.log("Deleting message:", msgId);
        msgRef.child(msgId).remove();
      },
      "Delete"
    );
  }
});

function sendMessage() {
  if (!currentUser || !currentChat) return;
  const text = document.getElementById("message").value.trim();
  if (!text) return;
  
  if (currentChat.type === "dm") {
    const key = [currentUserUid, currentChat.uid].sort().join("_");
    messagesRef.child(key).push({ senderUid: currentUserUid, text, timestamp: Date.now() });
  } else {
    groupsRef.child(currentChat.name).child("messages").push({ senderUid: currentUserUid, text, timestamp: Date.now() });
  }
  document.getElementById("message").value = "";
}

document.getElementById("add-friend-btn").onclick = () => {
  document.getElementById("add-friend-form").classList.toggle("active");
  document.getElementById("invite-section").classList.remove("active");
};

// Hide invite section when clicking anywhere in sidebar content (except groups)
document.getElementById("sidebar-content").addEventListener("click", (e) => {
  // Check if click is on a group or inside the invite section
  const isGroupClick = e.target.closest('.group-div');
  const isInviteSectionClick = e.target.closest('#invite-section');
  
  // If not clicking a group and not clicking inside invite section, hide invite section
  if (!isGroupClick && !isInviteSectionClick) {
    document.getElementById("invite-section").classList.remove("active");
  }
});

document.getElementById("send-request-btn").onclick = () => {
  const friendUsername = document.getElementById("friend-username").value.trim();
  if (!friendUsername) return;
  
  usersRef.orderByChild("username").equalTo(friendUsername).once("value").then(snapshot => {
    if (!snapshot.exists()) {
      alert("User not found!");
    } else {
      snapshot.forEach(child => {
        const friendUid = child.key;
        if (friendUid === currentUserUid) {
          alert("You can't add yourself!");
        } else {
          usersRef.child(friendUid).child("requests").child(currentUserUid).set(true);
          alert("Friend request sent!");
          document.getElementById("friend-username").value = "";
          document.getElementById("add-friend-form").classList.remove("active");
        }
      });
    }
  });
};

document.getElementById("create-group-btn").onclick = () => {
  document.getElementById("create-group-form").classList.toggle("active");
  // Only hide invite section if we're not currently in a group chat
  if (!currentChat || currentChat.type !== "group") {
    document.getElementById("invite-section").classList.remove("active");
  }
};

document.getElementById("create-group-confirm").onclick = () => {
  const groupName = document.getElementById("group-name").value.trim();
  if (!groupName) return;
  groupsRef.child(groupName).set({
    creator: currentUserUid,
    members: { [currentUserUid]: true },
    messages: {}
  });
  document.getElementById("group-name").value = "";
  document.getElementById("create-group-form").classList.remove("active");
};

document.getElementById("message").addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

// ========== Change Avatar ==========
document.getElementById("change-pfp-btn").onclick = () => {
  document.getElementById("change-pfp-form").classList.toggle("active");
};

document.getElementById("save-pfp-btn").onclick = () => {
  const newUrl = document.getElementById("new-pfp-url").value.trim();
  if (!newUrl) return;
  
  usersRef.child(currentUserUid).child("profilePic").set(newUrl);
  document.getElementById("new-pfp-url").value = "";
  document.getElementById("change-pfp-form").classList.remove("active");
  
  loadFriends();
  if (currentChat) {
    if (currentChat.type === "dm") {
      usersRef.child(currentChat.uid).child("profilePic").get().then(picSnap => {
        openDM(currentChat.uid, {username: document.getElementById("chat-header-name").textContent, profilePic: picSnap.val()});
      });
    } else {
      joinGroup(currentChat.name);
    }
  }
};

// ========== Members Panel ==========
const memberToggle = document.getElementById("member-toggle");
const memberPanel = document.getElementById("member-panel");
const memberClose = document.getElementById("member-close");

if (memberToggle) {
  memberToggle.onclick = () => {
    memberPanel.classList.toggle("active");
    updateMembers();
  };
}

if (memberClose) {
  memberClose.onclick = () => {
    memberPanel.classList.remove("active");
  };
}

function updateMembers() {
  if (!currentChat || currentChat.type !== "group") return;
  
  memberPanel.querySelectorAll(".member-div").forEach(div => div.remove());
  
  groupsRef.child(currentChat.name).child("members").get().then(snap => {
    const members = snap.val();
    for (const memberUid in members) {
      usersRef.child(memberUid).once("value").then(memberSnap => {
        const memberData = memberSnap.val();
        const div = document.createElement("div");
        div.className = "member-div";
        
        const avatar = document.createElement("div");
        avatar.className = "member-avatar";
        avatar.textContent = memberData.username.charAt(0).toUpperCase();
        
        const info = document.createElement("div");
        info.className = "member-info";
        
        const name = document.createElement("div");
        name.className = "member-name";
        name.textContent = memberData.username;
        
        const status = document.createElement("div");
        status.className = "member-status";
        const online = memberData.online || false;
        status.innerHTML = `<span class="status-indicator ${online ? 'status-online' : 'status-offline'}"></span> ${online ? 'Online' : 'Offline'}`;
        
        info.appendChild(name);
        info.appendChild(status);
        div.appendChild(avatar);
        div.appendChild(info);
        memberPanel.appendChild(div);
      });
    }
  });
}

// ========== Invite to Group ==========
document.getElementById("invite-btn").onclick = () => {
  const friendUsername = document.getElementById("invite-username").value.trim();
  if (!friendUsername) {
    alert("Enter username");
    return;
  }
  
  if (!currentChat || currentChat.type !== "group") {
    alert("You must be in a group to invite someone!");
    return;
  }
  
  // First, search for the user by username
  usersRef.orderByChild("username").equalTo(friendUsername).once("value").then(snapshot => {
    if (!snapshot.exists()) {
      alert("User not found!");
      return;
    }
    
    // Get the friend's UID
    let friendUid = null;
    snapshot.forEach(child => {
      friendUid = child.key;
    });
    
    // Check if they're your friend
    usersRef.child(currentUserUid).child("friends").child(friendUid).once("value").then(fSnap => {
      if (!fSnap.exists()) {
        alert("You can only invite friends to groups!");
        return;
      }
      
      // Check if they're already in the group
      groupsRef.child(currentChat.name).child("members").child(friendUid).once("value").then(memberSnap => {
        if (memberSnap.exists()) {
          alert(friendUsername + " is already in this group!");
          return;
        }
        
        // Add them to the group
        groupsRef.child(currentChat.name).child("members").child(friendUid).set(true);
        alert(friendUsername + " added to the group!");
        document.getElementById("invite-username").value = "";
        updateMembers();
      });
    });
  });
};

window.onload = () => {
  auth.onAuthStateChanged(user => {
    if (user) {
      usersRef.child(user.uid).update({ online:true });
      usersRef.child(user.uid).once('value').then(snap => {
        const userData = snap.val();
        login(user.uid, userData.username || user.displayName || user.email.split("@")[0]);
      });
    }
  });
};
</script>
</body>
</html>
