<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif; background:#36393f; color:#dcddde; display:flex; height:100vh; overflow:hidden; }

  /* Sidebar */
  #sidebar { width:280px; background:#2f3136; display:none; flex-direction:column; border-right:1px solid #202225; }
  #sidebar.active { display:flex; }
  #sidebar-header { padding:16px; background:#202225; border-bottom:1px solid #18191c; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  #sidebar-header h2 { font-size:16px; font-weight:600; color:#fff; }
  #sidebar-content { flex:1; overflow-y:auto; padding:8px; }
  #sidebar-content::-webkit-scrollbar { width:8px; }
  #sidebar-content::-webkit-scrollbar-track { background:transparent; }
  #sidebar-content::-webkit-scrollbar-thumb { background:#202225; border-radius:4px; }
  .section-title { font-size:12px; font-weight:600; text-transform:uppercase; color:#8e9297; padding:16px 8px 4px; display:flex; justify-content:space-between; align-items:center; }
  .add-btn { background:none; border:none; color:#8e9297; cursor:pointer; font-size:18px; padding:0; width:20px; height:20px; border-radius:4px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .add-btn:hover { background:#3ba55c; color:#fff; }
  .friend-div, .group-div, .request-div { display:flex; align-items:center; padding:8px; margin:2px 0; border-radius:8px; cursor:pointer; transition:all 0.2s; background:transparent; }
  .friend-div:hover, .group-div:hover { background:#3e4147; }
  .friend-div.active, .group-div.active { background:#404249; }
  .friend-div img, .group-div .group-icon { width:36px; height:36px; border-radius:50%; margin-right:12px; object-fit:cover; }
  .group-icon { background:#5865f2; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:16px; color:#fff; }
  .friend-info, .group-info { flex:1; min-width:0; }
  .friend-name, .group-name { font-size:15px; font-weight:500; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .friend-status { font-size:12px; color:#b9bbbe; margin-top:2px; }
  .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; }
  .status-online { background:#3ba55c; } 
  .status-offline { background:#747f8d; }
  .request-div { background:#2f3136; border:1px solid #404249; padding:12px; margin:4px 0; border-radius:8px; cursor:default; }
  .request-text { font-size:14px; margin-bottom:8px; color:#dcddde; }
  .request-buttons { display:flex; gap:8px; }
  .input-form { display:none; padding:12px; background:#202225; border-radius:8px; margin:8px 0; }
  .input-form.active { display:block; }
  #user-controls { padding:12px; background:#202225; border-top:1px solid #18191c; display:flex; gap:8px; margin-top:auto; flex-shrink:0; }

  /* Buttons */
  .btn { padding:8px 16px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
  .btn-primary { background:#5865f2; color:#fff; }
  .btn-primary:hover { background:#4752c4; }
  .btn-secondary { background:#4e5058; color:#fff; }
  .btn-secondary:hover { background:#5d5f67; }
  .btn-danger { background:#ed4245; color:#fff; }
  .btn-danger:hover { background:#c03537; }
  .btn-success { background:#3ba55c; color:#fff; width:100%; }
  .btn-success:hover { background:#2d7d46; }
  .btn-small { padding:4px 12px; font-size:12px; }

  /* Auth Screen */
  #auth { display:flex; align-items:center; justify-content:center; height:100%; width:100%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
  #auth-box { background:#36393f; padding:32px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.4); width:100%; max-width:420px; }
  #auth-title { font-size:24px; font-weight:700; color:#fff; margin-bottom:8px; text-align:center; }
  #auth-subtitle { font-size:14px; color:#b9bbbe; margin-bottom:24px; text-align:center; }
  #auth-msg { background:#ed4245; color:#fff; padding:12px; border-radius:6px; font-size:14px; margin-bottom:16px; display:none; }
  #auth-msg.show { display:block; }
  .auth-input-group { margin-bottom:16px; }
  .auth-input-label { display:block; font-size:12px; font-weight:600; color:#b9bbbe; text-transform:uppercase; margin-bottom:8px; }
  .auth-buttons { display:flex; gap:12px; margin-top:24px; }
  .auth-buttons .btn { flex:1; }
  input[type="text"], input[type="password"] { width:100%; padding:10px 12px; background:#40444b; border:1px solid transparent; border-radius:6px; color:#dcddde; font-size:14px; margin:6px 0; transition:all 0.2s; }
  input[type="text"]:focus, input[type="password"]:focus { outline:none; border-color:#5865f2; background:#383c43; }
  input::placeholder { color:#72767d; }

  /* Chat Area */
  #main { flex:1; display:flex; flex-direction:column; background:#36393f; position:relative; }
  #chat-header { height:56px; background:#36393f; border-bottom:1px solid #202225; display:none; align-items:center; padding:0 16px; box-shadow:0 1px 0 rgba(0,0,0,0.2); }
  #chat-header.active { display:flex; }
  #chat-header-img { width:32px; height:32px; border-radius:50%; margin-right:12px; object-fit:cover; }
  #chat-header-name { font-size:16px; font-weight:600; color:#fff; }
  #chat { flex:1; overflow-y:auto; padding:16px; display:none; }
  #chat.active { display:block; }
  #chat::-webkit-scrollbar { width:12px; }
  #chat::-webkit-scrollbar-thumb { background:#202225; border-radius:6px; border:3px solid #36393f; }
  .message-div { display:flex; align-items:flex-start; padding:4px 0; margin:4px 0; transition:background 0.1s; }
  .message-div:hover { background:rgba(4,4,5,0.07); }
  .message-div img { width:40px; height:40px; border-radius:50%; margin-right:12px; object-fit:cover; }
  .message-content { flex:1; }
  .message-header { display:flex; align-items:baseline; margin-bottom:4px; }
  .message-sender { font-size:15px; font-weight:500; color:#fff; margin-right:8px; }
  .message-time { font-size:12px; color:#72767d; }
  .message-text { font-size:15px; color:#dcddde; line-height:1.5; word-wrap:break-word; }
  #send-div { padding:16px; display:none; }
  #send-div.active { display:block; }
  .send-container { background:#40444b; border-radius:8px; padding:4px; display:flex; align-items:center; gap:8px; }
  #message { flex:1; background:transparent; border:none; padding:8px 12px; color:#dcddde; font-size:15px; margin:0; }
  #message:focus { outline:none; }
  .send-btn { background:#5865f2; border:none; color:#fff; padding:10px 16px; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
  .send-btn:hover { background:#4752c4; }
  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#72767d; }
  .empty-icon { font-size:64px; margin-bottom:16px; opacity:0.3; }
  .empty-text { font-size:16px; font-weight:500; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <h2>ðŸ’¬ Chats</h2>
  </div>
  <div id="sidebar-content">
    <div class="section-title">Friends <button class="add-btn" id="add-friend-btn">+</button></div>
    <div class="input-form" id="add-friend-form">
      <input type="text" id="friend-username" placeholder="Enter username">
      <button class="btn btn-primary btn-small" id="send-request-btn">Send Request</button>
    </div>
    <div id="friend-list"></div>
    <div class="section-title" style="margin-top:16px;">Friend Requests</div>
    <div id="request-list"></div>
    <div class="section-title" style="margin-top:16px;">Groups <button class="add-btn" id="create-group-btn">+</button></div>
    <div class="input-form" id="create-group-form">
      <input type="text" id="group-name" placeholder="Group name">
      <button class="btn btn-primary btn-small" id="create-group-confirm">Create</button>
    </div>
    <div id="group-list"></div>
  </div>
  <div id="user-controls">
    <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
  </div>
</div>

<div id="main">
  <div id="auth">
    <div id="auth-box">
      <h2 id="auth-title">Welcome Back!</h2>
      <p id="auth-subtitle">We're so excited to see you again!</p>
      <div id="auth-msg"></div>
      <div class="auth-input-group">
        <label class="auth-input-label">Username</label>
        <input type="text" id="username" placeholder="Enter your username">
      </div>
      <div class="auth-input-group">
        <label class="auth-input-label">Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <div class="auth-input-group" id="profile-pic-group" style="display:none;">
        <label class="auth-input-label">Profile Picture URL (Optional)</label>
        <input type="text" id="profile-pic" placeholder="https://example.com/avatar.jpg">
      </div>
      <div class="auth-buttons">
        <button class="btn btn-primary" id="auth-btn">Sign In</button>
        <button class="btn btn-secondary" id="toggle-btn">Sign Up</button>
      </div>
      <button class="btn btn-success" id="google-btn" style="margin-top:12px;">Sign in with Google</button>
    </div>
  </div>

  <div id="chat-header">
    <div id="chat-header-info">
      <img id="chat-header-img" src="" alt="">
      <span id="chat-header-name"></span>
    </div>
  </div>

  <div id="chat">
    <div class="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div class="empty-text">Select a chat to start messaging</div>
    </div>
  </div>

  <div id="send-div">
    <div class="send-container">
      <input type="text" id="message" placeholder="Type a message...">
      <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
// ========== Firebase ==========
const firebaseConfig = {
  apiKey: "AIzaSyDJBkKZt3tRjrOxBXOhWmgu-faYMFvDaKw",
  authDomain: "chat-c5c92.firebaseapp.com",
  databaseURL: "https://chat-c5c92-default-rtdb.firebaseio.com",
  projectId: "chat-c5c92",
  storageBucket: "chat-c5c92.firebasestorage.app",
  messagingSenderId: "860358701745",
  appId: "1:860358701745:web:7ecfc8dd659396a0af6890",
  measurementId: "G-MYPKD9R9JD"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const usersRef = db.ref("users");
const messagesRef = db.ref("messages/dm");
const groupsRef = db.ref("groups");

let currentUser = null;
let currentUserUid = null;
let currentChat = null;
let isSignUp = false;

// ========== Elements ==========
const authDiv = document.getElementById("auth");
const authBtn = document.getElementById("auth-btn");
const toggleBtn = document.getElementById("toggle-btn");
const authMsg = document.getElementById("auth-msg");
const profilePicGroup = document.getElementById("profile-pic-group");
const sidebar = document.getElementById("sidebar");
const googleBtn = document.getElementById("google-btn");
const chatDiv = document.getElementById("chat");
const chatHeader = document.getElementById("chat-header");
const sendDiv = document.getElementById("send-div");

// ========== Toggle Sign In / Sign Up ==========
toggleBtn.onclick = () => {
  isSignUp = !isSignUp;
  if (isSignUp) {
    profilePicGroup.style.display = "block";
    authBtn.textContent = "Sign Up";
    toggleBtn.textContent = "Sign In";
  } else {
    profilePicGroup.style.display = "none";
    authBtn.textContent = "Sign In";
    toggleBtn.textContent = "Sign Up";
  }
  authMsg.classList.remove("show");
};

// ========== Show Message ==========
function showAuthMsg(msg) {
  authMsg.textContent = msg;
  authMsg.classList.add("show");
}

// ========== Login / Signup ==========
authBtn.onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const profilePic = document.getElementById("profile-pic").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg";

  if (!username || !password) { showAuthMsg("Enter username and password"); return; }

  if (isSignUp) {
    auth.createUserWithEmailAndPassword(username+"@dummy.com", password)
      .then(cred => {
        const uid = cred.user.uid;
        usersRef.child(uid).set({ username, profilePic, friends:{}, requests:{}, online:true });
        login(uid, username);
      })
      .catch(err => showAuthMsg(err.message));
  } else {
    auth.signInWithEmailAndPassword(username+"@dummy.com", password)
      .then(cred => {
        const uid = cred.user.uid;
        usersRef.child(uid).update({ online:true });
        usersRef.child(uid).once('value').then(snap => {
          login(uid, snap.val().username);
        });
      })
      .catch(err => showAuthMsg(err.message));
  }
};

// ========== Google Sign-In ==========
googleBtn.onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    const user = result.user;
    usersRef.child(user.uid).once("value").then(snap => {
      if (!snap.exists()) {
        usersRef.child(user.uid).set({ username: user.displayName, profilePic: user.photoURL, friends:{}, requests:{}, online:true });
      } else {
        usersRef.child(user.uid).update({ online:true });
      }
      login(user.uid, user.displayName);
    });
  }).catch(err => showAuthMsg(err.message));
};

// ========== Login Handler ==========
function login(uid, username) {
  currentUser = username;
  currentUserUid = uid;
  localStorage.setItem("miniDiscordUser", uid);
  authDiv.style.display = "none";
  sidebar.classList.add("active");
  loadFriends();
  loadRequests();
  loadGroups();
}

// ========== Logout ==========
function logout() {
  if (currentUserUid) {
    usersRef.child(currentUserUid).update({ online:false });
  }
  auth.signOut();
  localStorage.removeItem("miniDiscordUser");
  currentUser = null;
  currentUserUid = null;
  currentChat = null;
  sidebar.classList.remove("active");
  chatDiv.classList.remove("active");
  chatHeader.classList.remove("active");
  sendDiv.classList.remove("active");
  authDiv.style.display = "flex";
}

// ========== Load Friends ==========
function loadFriends() {
  const friendListDiv = document.getElementById("friend-list");
  friendListDiv.innerHTML = "";
  usersRef.child(currentUserUid).child("friends").on("value", snapshot => {
    friendListDiv.innerHTML = "";
    snapshot.forEach(f => {
      const friendUid = f.key;
      usersRef.child(friendUid).once("value").then(friendSnap => {
        const friendData = friendSnap.val();
        const div = document.createElement("div");
        div.className = "friend-div";
        div.innerHTML = `
          <img src="${friendData.profilePic || 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg'}">
          <div class="friend-info">
            <div class="friend-name">${friendData.username}</div>
            <div class="friend-status">
              <span class="status-indicator ${friendData.online ? 'status-online' : 'status-offline'}"></span>
              ${friendData.online ? 'Online' : 'Offline'}
            </div>
          </div>
        `;
        div.onclick = () => openDM(friendUid, friendData);
        friendListDiv.appendChild(div);
      });
    });
  });
}

// ========== Load Requests ==========
function loadRequests() {
  const requestListDiv = document.getElementById("request-list");
  requestListDiv.innerHTML = "";
  usersRef.child(currentUserUid).child("requests").on("value", snapshot => {
    requestListDiv.innerHTML = "";
    snapshot.forEach(r => {
      const requesterUid = r.key;
      usersRef.child(requesterUid).once("value").then(reqSnap => {
        const requester = reqSnap.val();
        const div = document.createElement("div");
        div.className = "request-div";
        div.innerHTML = `
          <div class="request-text"><strong>${requester.username}</strong> wants to be friends</div>
          <div class="request-buttons">
            <button class="btn btn-success btn-small">Accept</button>
            <button class="btn btn-danger btn-small">Decline</button>
          </div>
        `;
        div.querySelector(".btn-success").onclick = () => {
          usersRef.child(currentUserUid).child("friends").child(requesterUid).set(true);
          usersRef.child(requesterUid).child("friends").child(currentUserUid).set(true);
          usersRef.child(currentUserUid).child("requests").child(requesterUid).remove();
        };
        div.querySelector(".btn-danger").onclick = () => {
          usersRef.child(currentUserUid).child("requests").child(requesterUid).remove();
        };
        requestListDiv.appendChild(div);
      });
    });
  });
}

// ========== Load Groups ==========
function loadGroups() {
  const groupListDiv = document.getElementById("group-list");
  groupListDiv.innerHTML = "";
  groupsRef.on("value", snapshot => {
    groupListDiv.innerHTML = "";
    snapshot.forEach(g => {
      const data = g.val();
      const name = g.key;
      if (!data.members || !data.members[currentUserUid]) return;
      const div = document.createElement("div");
      div.className = "group-div";
      const iconLetter = name.charAt(0).toUpperCase();
      div.innerHTML = `
        <div class="group-icon">${iconLetter}</div>
        <div class="group-info"><div class="group-name">${name}</div></div>
      `;
      div.onclick = () => joinGroup(name);
      groupListDiv.appendChild(div);
    });
  });
}

// ========== Open DM ==========
function openDM(friendUid, friendData) {
  currentChat = { type: "dm", uid: friendUid };
  chatDiv.innerHTML = "";
  chatDiv.classList.add("active");
  chatHeader.classList.add("active");
  sendDiv.classList.add("active");
  document.getElementById("chat-header-img").src = friendData.profilePic;
  document.getElementById("chat-header-name").textContent = friendData.username;
  
  const key = [currentUserUid, friendUid].sort().join("_");
  const ref = messagesRef.child(key);
  ref.off();
  ref.on("child_added", snap => renderMessage(snap, ref));
}

// ========== Join Group ==========
function joinGroup(name) {
  currentChat = { type: "group", name };
  chatDiv.innerHTML = "";
  chatDiv.classList.add("active");
  chatHeader.classList.add("active");
  sendDiv.classList.add("active");
  document.getElementById("chat-header-name").textContent = "# " + name;
  
  const ref = groupsRef.child(name).child("messages");
  ref.off();
  ref.on("child_added", snap => renderMessage(snap, ref));
}

// ========== Render Message ==========
function renderMessage(snapshot, ref) {
  const data = snapshot.val();
  const div = document.createElement("div");
  div.className = "message-div";
  
  usersRef.child(data.senderUid).once("value").then(senderSnap => {
    const sender = senderSnap.val();
    div.innerHTML = `
      <img src="${sender.profilePic || 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Default_pfp.jpg'}">
      <div class="message-content">
        <div class="message-header">
          <span class="message-sender">${sender.username}</span>
          <span class="message-time">${new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div class="message-text">${data.text}</div>
      </div>
    `;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}

// ========== Send Message ==========
function sendMessage
